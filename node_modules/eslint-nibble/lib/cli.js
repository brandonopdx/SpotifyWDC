'use strict';

var _nibbler = require('./nibbler');

var _nibbler2 = _interopRequireDefault(_nibbler);

var _formatters = require('./config/formatters');

var fmt = _interopRequireWildcard(_formatters);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _inquirer = require('inquirer');

var _inquirer2 = _interopRequireDefault(_inquirer);

var _eslintFilteredFix = require('eslint-filtered-fix');

var _trimStat = require('./trim-stat');

var _trimStat2 = _interopRequireDefault(_trimStat);

var _options = require('./config/options');

var _options2 = _interopRequireDefault(_options);

var _package = require('../package.json');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var cli = {

  execute: function execute(args) {
    var currentOptions = void 0,
        files = void 0,
        extensions = void 0,
        config = void 0;

    // Parse options
    try {
      currentOptions = _options2.default.parse(args);
      files = currentOptions._;
      extensions = currentOptions.ext;
      config = currentOptions.config;
    } catch (error) {
      console.error(error.message);
      return 1;
    }

    // Decide what to do based on options
    if (currentOptions.version) {
      // Show version from package.json
      console.log('v' + _package.version);
    } else if (currentOptions.help || !files.length) {
      // Show help
      console.log(_options2.default.generateHelp());
    } else {
      var configuration = { extensions: extensions };
      if (config) {
        configuration.configFile = config;
      }

      _nibbler2.default.configure(configuration);
      var report = _nibbler2.default.nibbleOnFiles(files);
      if (report && (report.errorCount > 0 || report.warningCount > 0)) {
        // Check if there was a fatal error
        var fatalReport = _nibbler2.default.getFatalResults(report);
        if (fatalReport) {
          var errors = _nibbler2.default.getFormattedResults(fatalReport, 'stylish');
          console.log(errors);
          console.error('Fatal error(s) were detected.  Please correct and try again.');
          return 1;
        }

        // Show summary
        var summary = _nibbler2.default.getFormattedResults(report, fmt.summary);
        console.log(summary);

        // Calculate stats array
        var stats = _nibbler2.default.getFormattedResults(report, fmt.stats).split('\n');

        // Determine the length of the longest stat
        var maxStatLen = stats.reduce(function (maxLen, stat) {
          return Math.max(maxLen, stat.length);
        }, 0);
        // Inquirer adds three characters, so we will need to trim them later
        var maxAllowedLen = maxStatLen - 3;

        // Create an array of choices from the stats
        // (filter removes empty stat at end)
        var results = stats.filter(function (stat) {
          return stat;
        }).map(function (stat) {
          var ruleName = stat.split(':')[0];
          // If the stat length is within 3 of max, we need to truncate it
          // so that the line does not wrap once inquirer adds a select arrow
          // (This throws off the relative length slightly, but not much)
          var fullStat = stat.length <= maxAllowedLen
          // Short enough to return as-is
          ? stat
          // Need to remove spaces, while accounting for 10 char ansi escape for color
          : (0, _trimStat2.default)(stat, maxAllowedLen);

          return {
            name: fullStat,
            value: ruleName,
            short: ruleName
          };
        });

        // Ask user for the rule to narrow in on
        _inquirer2.default.prompt([{
          name: 'rule',
          type: 'list',
          message: 'Which rule would you like to fix?',
          choices: results,
          pageSize: results.length
        }, {
          name: 'fix',
          type: 'confirm',
          message: 'Would you like to attempt to auto-fix?',
          default: false,
          when: function when(answers) {
            var ruleReport = _nibbler2.default.getRuleResults(report, answers.rule);
            return ruleReport.fixableErrorCount > 0 || ruleReport.fixableWarningCount > 0;
          }
        }, {
          name: 'fixWarnings',
          type: 'confirm',
          message: 'Autofix warnings?',
          default: true,
          when: function when(answers) {
            if (!answers.fix) return false;

            var ruleReport = _nibbler2.default.getRuleResults(report, answers.rule);
            return ruleReport.fixableWarningCount > 0;
          }
        }]).then(function gotInput(answers) {
          // Display detailed error reports
          var ruleName = answers.rule;

          if (answers.fix) {
            var fixOptions = {
              rules: [ruleName],
              warnings: answers.fixWarnings
            };
            var fixedReport = (0, _eslintFilteredFix.fix)(files, fixOptions, configuration);
            var ruleResults = _nibbler2.default.getRuleResults(fixedReport, ruleName);
            if (ruleResults.errorCount > 0 || ruleResults.warningCount > 0) {
              var detailed = _nibbler2.default.getFormattedResults(ruleResults, fmt.detailed);
              console.log(detailed);
            } else {
              console.log(_chalk2.default.green('Fixes applied, ' + ruleName + ' is now passing'));
            }
          } else {
            var _ruleResults = _nibbler2.default.getRuleResults(report, ruleName);
            var _detailed = _nibbler2.default.getFormattedResults(_ruleResults, fmt.detailed);
            console.log(_detailed);
          }
        });

        // No report or not any errors or warnings
      } else {
        console.log(_chalk2.default.green('Great job, all lint rules passed.'));
        return 0;
      }
    }
    return 0;
  }
};

module.exports = cli;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGkuanMiXSwibmFtZXMiOlsiZm10IiwiY2xpIiwiZXhlY3V0ZSIsImFyZ3MiLCJjdXJyZW50T3B0aW9ucyIsImZpbGVzIiwiZXh0ZW5zaW9ucyIsImNvbmZpZyIsInBhcnNlIiwiXyIsImV4dCIsImVycm9yIiwiY29uc29sZSIsIm1lc3NhZ2UiLCJ2ZXJzaW9uIiwibG9nIiwiaGVscCIsImxlbmd0aCIsImdlbmVyYXRlSGVscCIsImNvbmZpZ3VyYXRpb24iLCJjb25maWdGaWxlIiwiY29uZmlndXJlIiwicmVwb3J0IiwibmliYmxlT25GaWxlcyIsImVycm9yQ291bnQiLCJ3YXJuaW5nQ291bnQiLCJmYXRhbFJlcG9ydCIsImdldEZhdGFsUmVzdWx0cyIsImVycm9ycyIsImdldEZvcm1hdHRlZFJlc3VsdHMiLCJzdW1tYXJ5Iiwic3RhdHMiLCJzcGxpdCIsIm1heFN0YXRMZW4iLCJyZWR1Y2UiLCJtYXhMZW4iLCJzdGF0IiwiTWF0aCIsIm1heCIsIm1heEFsbG93ZWRMZW4iLCJyZXN1bHRzIiwiZmlsdGVyIiwibWFwIiwicnVsZU5hbWUiLCJmdWxsU3RhdCIsIm5hbWUiLCJ2YWx1ZSIsInNob3J0IiwicHJvbXB0IiwidHlwZSIsImNob2ljZXMiLCJwYWdlU2l6ZSIsImRlZmF1bHQiLCJ3aGVuIiwiYW5zd2VycyIsInJ1bGVSZXBvcnQiLCJnZXRSdWxlUmVzdWx0cyIsInJ1bGUiLCJmaXhhYmxlRXJyb3JDb3VudCIsImZpeGFibGVXYXJuaW5nQ291bnQiLCJmaXgiLCJ0aGVuIiwiZ290SW5wdXQiLCJmaXhPcHRpb25zIiwicnVsZXMiLCJ3YXJuaW5ncyIsImZpeFdhcm5pbmdzIiwiZml4ZWRSZXBvcnQiLCJydWxlUmVzdWx0cyIsImRldGFpbGVkIiwiZ3JlZW4iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTs7OztBQUNBOztJQUFZQSxHOztBQUNaOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FB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LENBQXVCVyxXQUF2QixFQUFvQ3hCLFFBQXBDLENBQWxCO0FBQ0EsZ0JBQUl5QixZQUFZNUMsVUFBWixHQUF5QixDQUF6QixJQUE4QjRDLFlBQVkzQyxZQUFaLEdBQTJCLENBQTdELEVBQWdFO0FBQzlELGtCQUFJNEMsV0FBVyxrQkFBUXhDLG1CQUFSLENBQTRCdUMsV0FBNUIsRUFBeUNwRSxJQUFJcUUsUUFBN0MsQ0FBZjtBQUNBekQsc0JBQVFHLEdBQVIsQ0FBWXNELFFBQVo7QUFDRCxhQUhELE1BR087QUFDTHpELHNCQUFRRyxHQUFSLENBQVksZ0JBQU11RCxLQUFOLHFCQUE4QjNCLFFBQTlCLHFCQUFaO0FBQ0Q7QUFDRixXQWJELE1BYU87QUFDTCxnQkFBSXlCLGVBQWMsa0JBQVFaLGNBQVIsQ0FBdUJsQyxNQUF2QixFQUErQnFCLFFBQS9CLENBQWxCO0FBQ0EsZ0JBQUkwQixZQUFXLGtCQUFReEMsbUJBQVIsQ0FBNEJ1QyxZQUE1QixFQUF5Q3BFLElBQUlxRSxRQUE3QyxDQUFmO0FBQ0F6RCxvQkFBUUcsR0FBUixDQUFZc0QsU0FBWjtBQUNEO0FBQ0YsU0FuREg7O0FBcURGO0FBQ0MsT0FwR0QsTUFvR087QUFDTHpELGdCQUFRRyxHQUFSLENBQVksZ0JBQU11RCxLQUFOLENBQVksbUNBQVosQ0FBWjtBQUNBLGVBQU8sQ0FBUDtBQUNEO0FBQ0Y7QUFDRCxXQUFPLENBQVA7QUFDRDtBQTVJTyxDQUFWOztBQStJQUMsT0FBT0MsT0FBUCxHQUFpQnZFLEdBQWpCIiwiZmlsZSI6ImNsaS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IG5pYmJsZXIgZnJvbSAnLi9uaWJibGVyJztcbmltcG9ydCAqIGFzIGZtdCBmcm9tICcuL2NvbmZpZy9mb3JtYXR0ZXJzJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgaW5xdWlyZXIgZnJvbSAnaW5xdWlyZXInO1xuaW1wb3J0IHtmaXh9IGZyb20gJ2VzbGludC1maWx0ZXJlZC1maXgnO1xuaW1wb3J0IHRyaW1TdGF0IGZyb20gJy4vdHJpbS1zdGF0JztcbmltcG9ydCBvcHRpb25zIGZyb20gJy4vY29uZmlnL29wdGlvbnMnO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gJy4uL3BhY2thZ2UuanNvbic7XG5cbmxldCBjbGkgPSB7XG5cbiAgZXhlY3V0ZTogZnVuY3Rpb24gKGFyZ3MpIHtcbiAgICBsZXQgY3VycmVudE9wdGlvbnMsXG4gICAgICAgIGZpbGVzLFxuICAgICAgICBleHRlbnNpb25zLFxuICAgICAgICBjb25maWc7XG5cbiAgICAvLyBQYXJzZSBvcHRpb25zXG4gICAgdHJ5IHtcbiAgICAgIGN1cnJlbnRPcHRpb25zID0gb3B0aW9ucy5wYXJzZShhcmdzKTtcbiAgICAgIGZpbGVzID0gY3VycmVudE9wdGlvbnMuXztcbiAgICAgIGV4dGVuc2lvbnMgPSBjdXJyZW50T3B0aW9ucy5leHQ7XG4gICAgICBjb25maWcgPSBjdXJyZW50T3B0aW9ucy5jb25maWc7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgICByZXR1cm4gMTtcbiAgICB9XG5cbiAgICAvLyBEZWNpZGUgd2hhdCB0byBkbyBiYXNlZCBvbiBvcHRpb25zXG4gICAgaWYgKGN1cnJlbnRPcHRpb25zLnZlcnNpb24pIHtcbiAgICAgIC8vIFNob3cgdmVyc2lvbiBmcm9tIHBhY2thZ2UuanNvblxuICAgICAgY29uc29sZS5sb2coJ3YnICsgdmVyc2lvbik7XG4gICAgfSBlbHNlIGlmIChjdXJyZW50T3B0aW9ucy5oZWxwIHx8ICghZmlsZXMubGVuZ3RoKSkge1xuICAgICAgLy8gU2hvdyBoZWxwXG4gICAgICBjb25zb2xlLmxvZyhvcHRpb25zLmdlbmVyYXRlSGVscCgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY29uZmlndXJhdGlvbiA9IHsgZXh0ZW5zaW9ucyB9O1xuICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICBjb25maWd1cmF0aW9uLmNvbmZpZ0ZpbGUgPSBjb25maWc7XG4gICAgICB9XG5cbiAgICAgIG5pYmJsZXIuY29uZmlndXJlKGNvbmZpZ3VyYXRpb24pO1xuICAgICAgbGV0IHJlcG9ydCA9IG5pYmJsZXIubmliYmxlT25GaWxlcyhmaWxlcyk7XG4gICAgICBpZiAocmVwb3J0ICYmIChyZXBvcnQuZXJyb3JDb3VudCA+IDAgfHwgcmVwb3J0Lndhcm5pbmdDb3VudCA+IDApKSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHRoZXJlIHdhcyBhIGZhdGFsIGVycm9yXG4gICAgICAgIGxldCBmYXRhbFJlcG9ydCA9IG5pYmJsZXIuZ2V0RmF0YWxSZXN1bHRzKHJlcG9ydCk7XG4gICAgICAgIGlmIChmYXRhbFJlcG9ydCkge1xuICAgICAgICAgIGxldCBlcnJvcnMgPSBuaWJibGVyLmdldEZvcm1hdHRlZFJlc3VsdHMoZmF0YWxSZXBvcnQsICdzdHlsaXNoJyk7XG4gICAgICAgICAgY29uc29sZS5sb2coZXJyb3JzKTtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYXRhbCBlcnJvcihzKSB3ZXJlIGRldGVjdGVkLiAgUGxlYXNlIGNvcnJlY3QgYW5kIHRyeSBhZ2Fpbi4nKTtcbiAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNob3cgc3VtbWFyeVxuICAgICAgICBsZXQgc3VtbWFyeSA9IG5pYmJsZXIuZ2V0Rm9ybWF0dGVkUmVzdWx0cyhyZXBvcnQsIGZtdC5zdW1tYXJ5KTtcbiAgICAgICAgY29uc29sZS5sb2coc3VtbWFyeSk7XG5cbiAgICAgICAgLy8gQ2FsY3VsYXRlIHN0YXRzIGFycmF5XG4gICAgICAgIGxldCBzdGF0cyA9IG5pYmJsZXIuZ2V0Rm9ybWF0dGVkUmVzdWx0cyhyZXBvcnQsIGZtdC5zdGF0cylcbiAgICAgICAgICAuc3BsaXQoJ1xcbicpO1xuXG4gICAgICAgIC8vIERldGVybWluZSB0aGUgbGVuZ3RoIG9mIHRoZSBsb25nZXN0IHN0YXRcbiAgICAgICAgY29uc3QgbWF4U3RhdExlbiA9IHN0YXRzLnJlZHVjZSgobWF4TGVuLCBzdGF0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIE1hdGgubWF4KG1heExlbiwgc3RhdC5sZW5ndGgpO1xuICAgICAgICB9LCAwKTtcbiAgICAgICAgLy8gSW5xdWlyZXIgYWRkcyB0aHJlZSBjaGFyYWN0ZXJzLCBzbyB3ZSB3aWxsIG5lZWQgdG8gdHJpbSB0aGVtIGxhdGVyXG4gICAgICAgIGNvbnN0IG1heEFsbG93ZWRMZW4gPSBtYXhTdGF0TGVuIC0gMztcblxuICAgICAgICAvLyBDcmVhdGUgYW4gYXJyYXkgb2YgY2hvaWNlcyBmcm9tIHRoZSBzdGF0c1xuICAgICAgICAvLyAoZmlsdGVyIHJlbW92ZXMgZW1wdHkgc3RhdCBhdCBlbmQpXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBzdGF0cy5maWx0ZXIoc3RhdCA9PiBzdGF0KS5tYXAoc3RhdCA9PiB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSBzdGF0LnNwbGl0KCc6JylbMF07XG4gICAgICAgICAgLy8gSWYgdGhlIHN0YXQgbGVuZ3RoIGlzIHdpdGhpbiAzIG9mIG1heCwgd2UgbmVlZCB0byB0cnVuY2F0ZSBpdFxuICAgICAgICAgIC8vIHNvIHRoYXQgdGhlIGxpbmUgZG9lcyBub3Qgd3JhcCBvbmNlIGlucXVpcmVyIGFkZHMgYSBzZWxlY3QgYXJyb3dcbiAgICAgICAgICAvLyAoVGhpcyB0aHJvd3Mgb2ZmIHRoZSByZWxhdGl2ZSBsZW5ndGggc2xpZ2h0bHksIGJ1dCBub3QgbXVjaClcbiAgICAgICAgICBjb25zdCBmdWxsU3RhdCA9IHN0YXQubGVuZ3RoIDw9IG1heEFsbG93ZWRMZW5cbiAgICAgICAgICAgIC8vIFNob3J0IGVub3VnaCB0byByZXR1cm4gYXMtaXNcbiAgICAgICAgICAgID8gc3RhdFxuICAgICAgICAgICAgLy8gTmVlZCB0byByZW1vdmUgc3BhY2VzLCB3aGlsZSBhY2NvdW50aW5nIGZvciAxMCBjaGFyIGFuc2kgZXNjYXBlIGZvciBjb2xvclxuICAgICAgICAgICAgOiB0cmltU3RhdChzdGF0LCBtYXhBbGxvd2VkTGVuKTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lIDogZnVsbFN0YXQsXG4gICAgICAgICAgICB2YWx1ZTogcnVsZU5hbWUsXG4gICAgICAgICAgICBzaG9ydDogcnVsZU5hbWVcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBc2sgdXNlciBmb3IgdGhlIHJ1bGUgdG8gbmFycm93IGluIG9uXG4gICAgICAgIGlucXVpcmVyLnByb21wdChbe1xuICAgICAgICAgIG5hbWUgICAgOiAncnVsZScsXG4gICAgICAgICAgdHlwZSAgICA6ICdsaXN0JyxcbiAgICAgICAgICBtZXNzYWdlIDogJ1doaWNoIHJ1bGUgd291bGQgeW91IGxpa2UgdG8gZml4PycsXG4gICAgICAgICAgY2hvaWNlcyA6IHJlc3VsdHMsXG4gICAgICAgICAgcGFnZVNpemU6IHJlc3VsdHMubGVuZ3RoXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lICAgOiAnZml4JyxcbiAgICAgICAgICB0eXBlICAgOiAnY29uZmlybScsXG4gICAgICAgICAgbWVzc2FnZTogJ1dvdWxkIHlvdSBsaWtlIHRvIGF0dGVtcHQgdG8gYXV0by1maXg/JyxcbiAgICAgICAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICAgICAgICB3aGVuKGFuc3dlcnMpIHtcbiAgICAgICAgICAgIGxldCBydWxlUmVwb3J0ID0gbmliYmxlci5nZXRSdWxlUmVzdWx0cyhyZXBvcnQsIGFuc3dlcnMucnVsZSk7XG4gICAgICAgICAgICByZXR1cm4gcnVsZVJlcG9ydC5maXhhYmxlRXJyb3JDb3VudCA+IDAgfHwgcnVsZVJlcG9ydC5maXhhYmxlV2FybmluZ0NvdW50ID4gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lICAgOiAnZml4V2FybmluZ3MnLFxuICAgICAgICAgIHR5cGUgICA6ICdjb25maXJtJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0b2ZpeCB3YXJuaW5ncz8nLFxuICAgICAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgICAgICAgd2hlbihhbnN3ZXJzKSB7XG4gICAgICAgICAgICBpZiAoIWFuc3dlcnMuZml4KSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgIGxldCBydWxlUmVwb3J0ID0gbmliYmxlci5nZXRSdWxlUmVzdWx0cyhyZXBvcnQsIGFuc3dlcnMucnVsZSk7XG4gICAgICAgICAgICByZXR1cm4gcnVsZVJlcG9ydC5maXhhYmxlV2FybmluZ0NvdW50ID4gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1dKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIGdvdElucHV0KGFuc3dlcnMpIHtcbiAgICAgICAgICAgIC8vIERpc3BsYXkgZGV0YWlsZWQgZXJyb3IgcmVwb3J0c1xuICAgICAgICAgICAgbGV0IHJ1bGVOYW1lID0gYW5zd2Vycy5ydWxlO1xuXG4gICAgICAgICAgICBpZiAoYW5zd2Vycy5maXgpIHtcbiAgICAgICAgICAgICAgY29uc3QgZml4T3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBydWxlcyAgIDogW3J1bGVOYW1lXSxcbiAgICAgICAgICAgICAgICB3YXJuaW5nczogYW5zd2Vycy5maXhXYXJuaW5nc1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBjb25zdCBmaXhlZFJlcG9ydCA9IGZpeChmaWxlcywgZml4T3B0aW9ucywgY29uZmlndXJhdGlvbik7XG4gICAgICAgICAgICAgIGxldCBydWxlUmVzdWx0cyA9IG5pYmJsZXIuZ2V0UnVsZVJlc3VsdHMoZml4ZWRSZXBvcnQsIHJ1bGVOYW1lKTtcbiAgICAgICAgICAgICAgaWYgKHJ1bGVSZXN1bHRzLmVycm9yQ291bnQgPiAwIHx8IHJ1bGVSZXN1bHRzLndhcm5pbmdDb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICBsZXQgZGV0YWlsZWQgPSBuaWJibGVyLmdldEZvcm1hdHRlZFJlc3VsdHMocnVsZVJlc3VsdHMsIGZtdC5kZXRhaWxlZCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGV0YWlsZWQpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKGBGaXhlcyBhcHBsaWVkLCAke3J1bGVOYW1lfSBpcyBub3cgcGFzc2luZ2ApKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbGV0IHJ1bGVSZXN1bHRzID0gbmliYmxlci5nZXRSdWxlUmVzdWx0cyhyZXBvcnQsIHJ1bGVOYW1lKTtcbiAgICAgICAgICAgICAgbGV0IGRldGFpbGVkID0gbmliYmxlci5nZXRGb3JtYXR0ZWRSZXN1bHRzKHJ1bGVSZXN1bHRzLCBmbXQuZGV0YWlsZWQpO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkZXRhaWxlZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG5cbiAgICAgIC8vIE5vIHJlcG9ydCBvciBub3QgYW55IGVycm9ycyBvciB3YXJuaW5nc1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJ0dyZWF0IGpvYiwgYWxsIGxpbnQgcnVsZXMgcGFzc2VkLicpKTtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAwO1xuICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IGNsaTtcbiJdfQ==